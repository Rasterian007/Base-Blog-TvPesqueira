<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | TvPesqueira Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Montserrat:wght@800&display=swap" rel="stylesheet">
    <script src="access-control.js" defer></script> 

    <style>
        /* ESTILOS PADR√ÉO (SIMILARES AO POST-EDITOR) */
        :root { --cor-primaria: #FFD700; --cor-secundaria: #051e3e; --cor-terciaria: #ffffff; --cinza-fundo: #f0f2f5; --texto-escuro: #333; --texto-claro: #ccc; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--cinza-fundo); color: var(--texto-escuro); display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background-color: var(--cor-secundaria); color: var(--cor-terciaria); flex-shrink: 0; padding: 20px 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-logo { padding: 0 20px 20px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 20px; }
        .sidebar-logo a { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 800; display: block; }
        .sidebar-logo span.tv { color: var(--cor-primaria); }
        .sidebar nav ul li a { display: flex; align-items: center; padding: 12px 20px; font-size: 0.95rem; color: var(--texto-claro); gap: 10px; }
        .sidebar nav ul li a:hover,
        .sidebar nav ul li.active a { background-color: rgba(255, 255, 255, 0.1); color: var(--cor-primaria); border-left: 3px solid var(--cor-primaria); }

        /* CONTE√öDO PRINCIPAL */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .top-bar { background: var(--cor-terciaria); padding: 15px 30px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; min-height: 70px; }
        .page-header { font-size: 1.8rem; font-weight: 700; color: var(--cor-secundaria); }
        .dashboard-body { padding: 30px; flex-grow: 1; }
        .btn-primary { background: var(--cor-primaria); color: var(--cor-secundaria); font-weight: 700; padding: 10px 20px; border-radius: 4px; text-transform: uppercase; }

        /* CARDS DO DASHBOARD */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dashboard-card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dashboard-card h3 { font-size: 1rem; color: #777; margin-bottom: 10px; }
        .dashboard-card p { font-size: 2.5rem; font-weight: 800; color: var(--cor-secundaria); }

        /* TABELA DE POSTS */
        .recent-posts { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .recent-posts h2 { font-size: 1.5rem; color: var(--cor-secundaria); margin-bottom: 15px; }
        .post-table { width: 100%; border-collapse: collapse; }
        .post-table th, .post-table td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .post-table th { background: #f9f9f9; color: var(--cor-secundaria); font-weight: 600; }
        .post-table td .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .status-draft { background: #f39c12; color: white; }
        .status-published { background: #2ecc71; color: white; }
        .btn-action-small { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 5px; }
        .btn-edit { background: #3498db; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-destaque { background: var(--cor-primaria); color: var(--cor-secundaria); }
    </style>
</head>
<body onload="checkLoginAndRole()"> 
    <aside class="sidebar">
        <div class="sidebar-logo">
            <a href="admin.html">
                <span class="tv">TV</span><span class="nome">P</span><span style="display:initial;">ESQ.</span>
            </a>
        </div>
        <nav>
            <ul>
                <li class="active"><a href="admin.html">üìä <span>Dashboard</span></a></li>
                <li><a href="post-editor.html">üìù <span>Posts & Not√≠cias</span></a></li>
                <li id="link-paginas-estaticas" style="display:none;"><a href="#">üì∞ <span>P√°ginas Est√°ticas</span></a></li>
                <li id="link-usuarios" style="display:none;"><a href="#">üë§ <span>Usu√°rios</span></a></li>
                <li><a href="#" onclick="logout()">üö™ <span>Sair</span></a></li>
            </ul>
        </nav>
    </aside>

    <div class="main-content">
        
        <div class="top-bar">
            <h1 class="page-header">üìä Dashboard <span id="user-role-display" style="font-size:0.7em; color:#888;"></span></h1>
            <a href="post-editor.html" class="btn-primary">‚ûï Nova Not√≠cia</a>
        </div>

        <div class="dashboard-body">
            
            <div class="card-grid">
                <div class="dashboard-card">
                    <h3>Total de Not√≠cias</h3>
                    <p id="total-posts">0</p>
                </div>
                <div class="dashboard-card">
                    <h3>Not√≠cias Publicadas</h3>
                    <p id="published-posts">0</p>
                </div>
                <div class="dashboard-card">
                    <h3>Rascunhos</h3>
                    <p id="draft-posts">0</p>
                </div>
                <div class="dashboard-card">
                    <h3>Destaque Principal</h3>
                    <p id="main-destaque-title" style="font-size: 1.2rem; font-weight: 600;"></p>
                </div>
            </div>

            <div class="recent-posts">
                <h2>√öltimas Not√≠cias Postadas</h2>
                <table class="post-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√≠tulo</th>
                            <th>Categoria</th>
                            <th>Autor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="posts-table-body">
                        </tbody>
                </table>
            </div>

        </div>
    </div>

    <script>
        // Fun√ß√£o que carrega os dados e renderiza o dashboard
        function renderDashboard() {
            const posts = loadPosts().sort((a, b) => b.id - a.id); // Ordena pelo mais recente
            const role = localStorage.getItem(ROLE_KEY);

            // 1. Ocultar links restritos a Rep√≥rter (Simula√ß√£o: Admin tem mais links)
            if (role === 'reporter') {
                document.getElementById('link-paginas-estaticas').style.display = 'none';
                document.getElementById('link-usuarios').style.display = 'none';
            }
            document.getElementById('user-role-display').textContent = `(Fun√ß√£o: ${role.charAt(0).toUpperCase() + role.slice(1)})`;
            
            // 2. Estat√≠sticas
            const published = posts.filter(p => p.status === 'published').length;
            const draft = posts.filter(p => p.status === 'draft').length;
            const mainDestaque = posts.find(p => p.destaque === 'main');

            document.getElementById('total-posts').textContent = posts.length;
            document.getElementById('published-posts').textContent = published;
            document.getElementById('draft-posts').textContent = draft;
            document.getElementById('main-destaque-title').textContent = mainDestaque ? mainDestaque.title.substring(0, 30) + '...' : 'Nenhum';


            // 3. Tabela de Posts
            const tableBody = document.getElementById('posts-table-body');
            tableBody.innerHTML = ''; // Limpa antes de popular

            const postsToShow = posts.slice(0, 10); // Mostra os 10 mais recentes

            postsToShow.forEach(post => {
                // Condi√ß√£o para mostrar o bot√£o de destaque
                const isMainDestaque = post.destaque === 'main';
                const destaqueButton = `<button class="btn-action-small btn-destaque" onclick="handleDestaque(${post.id})">${isMainDestaque ? '‚≠ê Destaque Principal' : '‚ú® Promover'}</button>`;
                
                // Bot√µes de a√ß√£o
                const actionsHtml = `
                    <button class="btn-action-small btn-edit" onclick="editPostAdmin(${post.id})">‚úèÔ∏è</button>
                    <button class="btn-action-small btn-delete" onclick="deletePostAdmin(${post.id})">üóëÔ∏è</button>
                    ${destaqueButton}
                `;

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${post.id}</td>
                    <td>${post.title.substring(0, 40)}...</td>
                    <td>${post.category}</td>
                    <td>${post.author}</td>
                    <td><span class="tag status-${post.status}">${post.status === 'published' ? 'Publicado' : 'Rascunho'}</span></td>
                    <td>${actionsHtml}</td>
                `;
            });
        }
        
        function handleDestaque(postId) {
            let posts = loadPosts();
            const postIndex = posts.findIndex(p => p.id === postId);

            if (postIndex === -1) return alert("Post n√£o encontrado.");

            // Se j√° √© destaque principal, remove o destaque. Se n√£o √©, promove.
            if (posts[postIndex].destaque === 'main') {
                posts[postIndex].destaque = null;
                alert(`Removido o destaque principal de: ${posts[postIndex].title}`);
            } else {
                // Remove o destaque principal antigo e define o novo
                promoteToDestaque(posts, postId); 
                alert(`Definido como NOVO Destaque Principal: ${posts[postIndex].title}`);
            }
            
            savePosts(posts);
            renderDashboard();
        }

        function deletePostAdmin(postId) {
             if (confirm(`Tem certeza que deseja EXCLUIR o post ID ${postId}?`)) {
                let posts = loadPosts();
                posts = posts.filter(p => p.id !== postId);
                savePosts(posts);
                alert(`Post ID ${postId} exclu√≠do com sucesso!`);
                renderDashboard();
            }
        }

        function editPostAdmin(postId) {
            window.location.href = `post-editor.html?id=${postId}`;
        }


        // Chama a fun√ß√£o renderDashboard ap√≥s a autentica√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            if (checkLoginAndRole()) {
                renderDashboard();
            }
        });
    </script>
</body>
</html>