<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciar Postagens</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="access-control.js" defer></script> 
    
    <style>
        /* --- ESTILOS DE ADMIN GERAIS --- */
        :root {
            --cor-primaria: #051e3e; /* Azul Escuro */
            --cor-secundaria: #FFD700; /* Amarelo */
            --cor-fundo: #f4f5f7;
            --cor-texto: #333;
            --link-primario: #FFD700; 
            --link-secundario: #051e3e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); display: flex; min-height: 100vh; }
        a { text-decoration: none; color: inherit; }

        /* --- SIDEBAR (Copie os estilos do seu admin.html para consist√™ncia) --- */
        .sidebar {
            width: 250px;
            background: var(--link-secundario);
            color: white;
            flex-shrink: 0;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .logo { font-size: 1.5rem; text-align: center; margin-bottom: 30px; font-weight: 700; color: var(--link-primario); }
        .nav-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            transition: background 0.2s;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--link-primario);
            border-left: 3px solid var(--link-primario);
        }
        .sidebar a {
            color: inherit;
            text-decoration: none;
            display: block;
        }

        /* --- CONTE√öDO PRINCIPAL --- */
        .main-content {
            flex-grow: 1;
            padding: 30px;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-content h1 {
            font-size: 1.8rem;
            color: var(--link-secundario);
        }

        .btn-nova-postagem {
            background: #2ecc71;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            transition: background 0.2s;
        }
        .btn-nova-postagem:hover {
            background: #27ae60;
        }

        /* --- TABELA RESPONSIVA DE POSTAGENS --- */
        .post-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .post-table th, .post-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .post-table th {
            background-color: #f8f8f8;
            color: var(--link-secundario);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .post-table tr:hover {
            background-color: #fafafa;
        }

        /* Tags de Status */
        .status-tag {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .status-tag.published {
            background-color: #e6f7d9;
            color: #2ecc71;
        }
        .status-tag.draft {
            background-color: #fff3e0;
            color: #f39c12;
        }
        .status-tag.error { /* Exemplo extra de tag */
            background-color: #ffe6e6;
            color: #cc0000;
        }

        /* --- BOT√ïES DE A√á√ÉO --- */
        .actions-cell button {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 5px;
            transition: opacity 0.2s;
        }
        .actions-cell button:hover {
            opacity: 0.8;
        }

        .btn-edit { background: var(--link-primario); color: var(--link-secundario); font-weight: 700; }
        .btn-delete { background: #cc0000; color: white; }
        .btn-view { background: #3498db; color: white; }
        
        /* Responsividade Tabela (Opcional: empilha em telas pequenas) */
        @media screen and (max-width: 768px) {
            .post-table thead { display: none; }
            .post-table, .post-table tbody, .post-table tr, .post-table td {
                display: block;
                width: 100%;
            }
            .post-table tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            .post-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
            }
            .post-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: calc(50% - 20px);
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 700;
                color: var(--link-secundario);
            }
            .actions-cell {
                text-align: left;
                padding-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="admin.html" class="logo">TVPESQUEIRA</a>
        <nav>
            <ul>
                <li class="nav-item"><a href="admin.html">üè† <span>Dashboard</span></a></li>
                <li class="nav-item active"><a href="postagens.html">üìù <span>Postagens</span></a></li>
                <li class="nav-item"><a href="paginas-estaticas.html">üìÑ <span>P√°ginas Est√°ticas</span></a></li>
                <li class="nav-item"><a href="usuarios.html">üë§ <span>Usu√°rios</span></a></li>
            </ul>
        </nav>
    </div>
    
    <div class="main-content">
        <div class="header-content">
            <h1>Gerenciar Postagens</h1>
            <button class="btn-nova-postagem" id="btn-nova-postagem" onclick="window.location.href='post-editor.html'">+ Nova Postagem</button>
        </div>

        <table class="post-table">
            <thead>
                <tr>
                    <th style="width: 30%;">T√≠tulo</th>
                    <th style="width: 15%;">Data/Hora</th>
                    <th style="width: 15%;">Categoria</th>
                    <th style="width: 10%;">Autor</th>
                    <th style="width: 10%;">Status</th>
                    <th style="width: 20%;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="post-list-body">
                </tbody>
        </table>
    </div>

    <script>
        // Assume que loadPosts(), savePosts() e checkLoginAndRole() est√£o definidos em access-control.js
        
        function formatPostRow(post) {
            const statusClass = post.status === 'published' ? 'published' : 'draft';
            const statusText = post.status === 'published' ? 'Publicado' : 'Rascunho';
            
            // Simula√ß√£o simples de tempo
            const displayTime = post.time || new Date(post.createdAt).toLocaleDateString('pt-BR');
            
            // Determina se o bot√£o de Excluir deve ser habilitado
            const userRole = window.getUserRole ? window.getUserRole() : null;
            const isAdmin = userRole === 'admin';
            
            const deleteButton = isAdmin 
                ? `<button class="btn-delete" onclick="deletePost(${post.id})">Excluir</button>` 
                : `<button class="btn-delete" disabled title="A exclus√£o √© restrita ao Administrador.">Excluir</button>`;

            return `
                <tr id="post-row-${post.id}">
                    <td data-label="T√≠tulo">${post.title}</td>
                    <td data-label="Data/Hora">${displayTime}</td>
                    <td data-label="Categoria">${post.category}</td>
                    <td data-label="Autor">${post.author}</td>
                    <td data-label="Status"><span class="status-tag ${statusClass}">${statusText}</span></td>
                    <td data-label="A√ß√µes" class="actions-cell">
                        <button class="btn-view" onclick="window.open('post.html?id=${post.id}', '_blank')">Ver</button>
                        <button class="btn-edit" onclick="window.location.href='post-editor.html?id=${post.id}'">Editar</button>
                        ${deleteButton}
                    </td>
                </tr>
            `;
        }

        function renderPostList() {
            // Garante que a autentica√ß√£o est√° ok antes de carregar
            if (typeof checkLoginAndRole === 'function') {
                if (!checkLoginAndRole()) return;
            }
            
            // Assume que loadPosts est√° definido globalmente
            const allPosts = window.loadPosts ? window.loadPosts() : [];
            const postListBody = document.getElementById('post-list-body');
            
            if (allPosts.length === 0) {
                postListBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px;">
                    Nenhuma postagem encontrada. 
                    <a href="post-editor.html" style="color: #3498db;">Crie a primeira!</a>
                </td></tr>`;
                return;
            }
            
            // Ordena os posts pelo mais recente primeiro
            const sortedPosts = allPosts.sort((a, b) => b.createdAt - a.createdAt);
            
            const postsHtml = sortedPosts.map(post => formatPostRow(post)).join('');
            postListBody.innerHTML = postsHtml;
            
            // Aplica restri√ß√µes de fun√ß√£o
            applyRoleRestrictions();
        }
        
        function deletePost(postId) {
            if (confirm(`Tem certeza que deseja EXCLUIR o post ID ${postId}? Esta a√ß√£o n√£o pode ser desfeita na simula√ß√£o!`)) {
                // Remove do localStorage
                let posts = window.loadPosts();
                posts = posts.filter(p => p.id !== postId);
                window.savePosts(posts);

                // Remove da tabela
                const row = document.getElementById(`post-row-${postId}`);
                if (row) {
                    row.remove();
                    alert(`Postagem ID ${postId} removida com sucesso. (Simula√ß√£o Front-end)`);
                } else {
                    console.error("Erro: A linha (<tr>) da postagem n√£o foi encontrada.");
                    alert("Erro interno: N√£o foi poss√≠vel localizar a postagem para exclus√£o.");
                }
            }
        }
        
        // Esta fun√ß√£o simula a restri√ß√£o de permiss√£o (Admin vs. Rep√≥rter)
        function applyRoleRestrictions() {
            const userRole = window.getUserRole ? window.getUserRole() : null; 
            
            // Oculta/Desabilita o bot√£o 'Excluir' e o bot√£o 'Nova Postagem' para Rep√≥rteres
            if (userRole === 'reporter') {
                // O bot√£o de exclus√£o j√° √© desabilitado/ocultado na fun√ß√£o formatPostRow
                
                // Oculta o bot√£o de adicionar nova postagem
                const btnAdd = document.getElementById('btn-nova-postagem');
                if (btnAdd) {
                    btnAdd.style.display = 'none';
                    alert("Aviso: Rep√≥rteres t√™m a op√ß√£o 'Nova Postagem' e 'Excluir' desabilitadas nesta simula√ß√£o.");
                }
            }
        }

        // Carrega e renderiza a lista de posts ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', renderPostList);

    </script>

</body>
</html>